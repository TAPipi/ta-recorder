<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hopureo (Recorder) </title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --karikiorangi: #006b6e;
      --orowaru: #31bcad;
      --sand: #f5edcd;
      --whalebone: #e0ddcc;
      --text: #000d31;
      --muted: #555;
      --border: #b9c3c5;
    }
    html, body { margin: 0; padding: 0; background: transparent; }
    body { font-family: 'Raleway', sans-serif; color: var(--text); background: transparent; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 0; background: transparent; width: 100%; }

    .card { background: #fff; border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); width: 100%; box-sizing: border-box; }

    h1 { font-size: 1.3rem; margin: 0 0 8px; color: var(--karikiorangi); font-weight: 600; }
    p { margin: 0 0 12px; color: var(--muted); font-weight: 400; line-height: 1.6; }

    .controls { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 12px; }
    button, .btn { border: 0; padding: 10px 14px; border-radius: 10px; background: var(--orowaru); color: #000; font-weight: 600; cursor: pointer; line-height: 1.2; font-size: 16px; transition: transform .02s ease-in-out; }
    button.primary { background: var(--orowaru); }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; }
    button:disabled { opacity: 0.6; cursor: not-allowed; filter: saturate(80%); }
    button:hover:not(:disabled), .btn:hover:not([aria-disabled='true']) { outline: 2px solid var(--ring, #c7dedd); }

    button i, .btn i { font-size: 18px; margin-right: 6px; }

    .status { font-size: 0.95rem; color: var(--text); margin: 8px 0; }
    .status small { color: var(--muted); }

    .meter { width: 100%; height: 10px; background: var(--whalebone); border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
    .meter > span { display: block; width: 0%; height: 100%; background: var(--orowaru); transition: width 100ms linear; }

    .row { display: grid; grid-template-columns: 1fr; gap: 12px; align-items: center; }
    @media (min-width: 560px) { .row { grid-template-columns: 1fr auto; } }

    .audio-box { display: flex; align-items: center; gap: 10px; }
    audio { width: 100%; }

    .note { font-size: 0.9rem; color: var(--muted); }
    button.secondary, .btn.secondary { background: var(--whalebone); color: #000; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-labelledby="rec-title">
      <h1 id="rec-title">Hopureo (Recorder)</h1>
      <p>Use this recorder to practise your pronunciation, then click play to hear it back.<br>Click download if you'd like to keep the recording for reference.</p>

      <div class="status" aria-live="polite" id="status">Ready. Microphone permission is required when you start.</div>

      <div class="row">
        <div>
          <div class="controls">
            <button class="primary" id="btnStart"><i class="bi bi-record-circle"></i>Record</button>
            <button id="btnPause" disabled><i class="bi bi-pause-circle"></i>Pause</button>
            <button id="btnResume" disabled><i class="bi bi-play-circle"></i>Resume</button>
            <button id="btnStop" disabled><i class="bi bi-stop-circle"></i>Stop</button>
          </div>
          <div class="controls">
            <button id="btnPlay" disabled><i class="bi bi-soundwave"></i>Play</button>
            <a id="btnDownload" class="btn secondary" href="#" download rel="noopener" aria-disabled="true"><i class="bi bi-download"></i>Download</a>
            <button id="btnReset" class="secondary" disabled><i class="bi bi-arrow-clockwise"></i>Reset</button>
          </div>
          <div class="status"><strong>Timer:</strong> <span id="timer">00:00</span> <small>(max 3 minutes)</small></div>
          <div class="meter" aria-hidden="true" title="Input level"><span id="level"></span></div>
        </div>
        <div class="audio-box">
          <audio id="player" controls preload="none"></audio>
        </div>
      </div>

      <p class="note">Tip: use a headset mic if you can. If you do not see a permission prompt, check your browser settings. Some older browsers do not support recording.</p>
    </div>
  </div>

  <script>
    (function() {
      const el = (id) => document.getElementById(id);
      const status = el('status');
      const timerEl = el('timer');
      const levelBar = el('level');
      const player = el('player');
      const btnStart = el('btnStart');
      const btnPause = el('btnPause');
      const btnResume = el('btnResume');
      const btnStop = el('btnStop');
      const btnPlay = el('btnPlay');
      const btnDownload = el('btnDownload');
      const btnReset = el('btnReset');
      const MAX_SECONDS = 180;

      let stream, mediaRecorder, chunks = [], mimeType = '', ext = 'webm', startTs = 0, tickId = null;
      let audioCtx, analyser, sourceNode, rafId;
      const levelArray = new Uint8Array(1);

      function supportedType() {
        if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) { mimeType='audio/webm;codecs=opus'; ext='webm'; return true; }
        if (window.MediaRecorder && MediaRecorder.isTypeSupported('audio/mp4')) { mimeType='audio/mp4'; ext='m4a'; return true; }
        if (window.MediaRecorder) { mimeType=''; ext='webm'; return true; }
        return false;
      }
      function fmt(seconds){const m=Math.floor(seconds/60).toString().padStart(2,'0');const s=Math.floor(seconds%60).toString().padStart(2,'0');return `${m}:${s}`;}
      function setStatus(msg){status.textContent=msg;}
      function enableDuringRecord(on){btnStart.disabled=on;btnPause.disabled=!on;btnStop.disabled=!on;btnResume.disabled=true;btnPlay.disabled=true;btnDownload.setAttribute('aria-disabled','true');btnReset.disabled=true;}
      function enableAfterRecord(){btnStart.disabled=false;btnPause.disabled=true;btnResume.disabled=true;btnStop.disabled=true;btnPlay.disabled=false;btnDownload.removeAttribute('aria-disabled');btnReset.disabled=false;}
      function startLevelMeter(s){stopLevelMeter();audioCtx=new (window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=32;sourceNode=audioCtx.createMediaStreamSource(s);sourceNode.connect(analyser);const update=()=>{analyser.getByteFrequencyData(levelArray);const val=levelArray[0]||0;const pct=Math.min(100,Math.max(0,Math.round((val/255)*100)));levelBar.style.width=pct+'%';rafId=requestAnimationFrame(update);};update();}
      function stopLevelMeter(){if(rafId)cancelAnimationFrame(rafId);if(audioCtx){try{audioCtx.close();}catch(e){}audioCtx=null;analyser=null;sourceNode=null;}levelBar.style.width='0%';}
      function startTimer(){startTs=Date.now();tickId=setInterval(()=>{const t=(Date.now()-startTs)/1000;timerEl.textContent=fmt(t);if(t>=MAX_SECONDS){stopRecording('Time limit reached, stopping recording.');}},200);}
      function stopTimer(){if(tickId)clearInterval(tickId);}
      async function startRecording(){if(!supportedType()){setStatus('Recording is not supported in this browser.');return;}try{stream=await navigator.mediaDevices.getUserMedia({audio:true});}catch(err){setStatus('Microphone permission was blocked.');return;}chunks=[];try{mediaRecorder=mimeType?new MediaRecorder(stream,{mimeType}):new MediaRecorder(stream);}catch(e){setStatus('Could not start the recorder.');return;}mediaRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)chunks.push(e.data);};mediaRecorder.onstart=()=>{enableDuringRecord(true);setStatus('Recording…');startTimer();startLevelMeter(stream);};mediaRecorder.onpause=()=>{setStatus('Paused.');};mediaRecorder.onresume=()=>{setStatus('Recording…');};mediaRecorder.onstop=()=>{stopTimer();stopLevelMeter();stream.getTracks().forEach(tr=>tr.stop());const blob=new Blob(chunks,{type:mimeType||'audio/webm'});const url=URL.createObjectURL(blob);player.src=url;player.load();const ts=new Date();const name=`recording-${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}-${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}${String(ts.getSeconds()).padStart(2,'0')}.${ext}`;btnDownload.href=url;btnDownload.download=name;enableAfterRecord();setStatus('Recording ready. You can play back or download your file.');};mediaRecorder.start(100);}
      function pauseRecording(){if(mediaRecorder&&mediaRecorder.state==='recording'){mediaRecorder.pause();btnPause.disabled=true;btnResume.disabled=false;}}
      function resumeRecording(){if(mediaRecorder&&mediaRecorder.state==='paused'){mediaRecorder.resume();btnPause.disabled=false;btnResume.disabled=true;}}
      function stopRecording(msg){if(mediaRecorder&&(mediaRecorder.state==='recording'||mediaRecorder.state==='paused')){mediaRecorder.stop();setStatus(msg||'Stopping…');}}
      function playAudio(){if(player.src){player.play();}}
      function resetAll(){stopTimer();stopLevelMeter();if(player.src){URL.revokeObjectURL(player.src);player.removeAttribute('src');player.load();}chunks=[];mediaRecorder=null;stream=null;timerEl.textContent='00:00';enableAfterRecord();btnPlay.disabled=true;btnDownload.setAttribute('aria-disabled','true');btnReset.disabled=true;setStatus('Ready. Microphone permission is required when you start.');}
      btnStart.addEventListener('click',startRecording);btnPause.addEventListener('click',pauseRecording);btnResume.addEventListener('click',resumeRecording);btnStop.addEventListener('click',()=>stopRecording());btnPlay.addEventListener('click',playAudio);btnReset.addEventListener('click',resetAll);
      btnDownload.addEventListener('click',e=>{if(btnDownload.getAttribute('aria-disabled')==='true')e.preventDefault();});
      if(location.protocol!=='https:'&&location.hostname!=='localhost'){setStatus('Recording requires HTTPS or localhost.');btnStart.disabled=true;}
      if(!('mediaDevices' in navigator)||!('getUserMedia' in navigator.mediaDevices)){setStatus('Microphone access not supported.');btnStart.disabled=true;}
      if(!window.MediaRecorder){setStatus('Your browser does not support recording.');btnStart.disabled=true;}
    })();
  </script>
</body>
</html>
